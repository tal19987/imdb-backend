pipeline {
    agent {
        node {
            label 'master'
            customWorkspace '/var/lib/jenkins/workspace/imdb-python-backend/server'
        }
    }
    environment {
        repository = "tal19987/imdb-backend"
        dockerhub_credential = "dockerhub-account"
        imageName = "${repository}:backend-${env.BUILD_ID}"
        google_project_id = "learned-battery-260616"
        kubernetes_cluster_name = "cluster-1"
        location = "us-central1-c"
        credentials_id = "My First Project"
    }
    stages {
        stage ("Build Docker Image") {
            steps {
                script {
                    image = docker.build(imageName, "-f ./Dockerfile")
                }
            }
        }
        stage ("Publish to DockerHub Repository")
        {
            steps {
                script {
                        docker.withRegistry('',dockerhub_credential) {
                            image.push()
                            image.push('latest')
                    }
                }
            }
        }
        stage ("Deploy to Kubernetes") {
            steps {
                step ([
                    $class: 'KubernetesEngineBuilder',
                    projectId: env.google_project_id,
                    clusterName: env.kubernetes_cluster_name,
                    location: env.location,
                    manifestPattern: 'backend-deployment.yaml',
                    credentialsId: env.credentials_id,
                    verifyDeployments: true
                ]) 
            }
        }
    }
    post {
        always {
            sh "docker rmi -f ${image.id}"
        }
    }
}